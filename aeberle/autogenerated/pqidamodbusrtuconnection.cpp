/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
*
* Copyright 2013 - 2023, nymea GmbH
* Contact: contact@nymea.io
*
* This fileDescriptor is part of nymea.
* This project including source code and documentation is protected by
* copyright law, and remains the property of nymea GmbH. All rights, including
* reproduction, publication, editing and translation, are reserved. The use of
* this project is subject to the terms of a license agreement to be concluded
* with nymea GmbH in accordance with the terms of use of nymea GmbH, available
* under https://nymea.io/license
*
* GNU Lesser General Public License Usage
* Alternatively, this project may be redistributed and/or modified under the
* terms of the GNU Lesser General Public License as published by the Free
* Software Foundation; version 3. This project is distributed in the hope that
* it will be useful, but WITHOUT ANY WARRANTY; without even the implied
* warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
* Lesser General Public License for more details.
*
* You should have received a copy of the GNU Lesser General Public License
* along with this project. If not, see <https://www.gnu.org/licenses/>.
*
* For any further details and any questions please contact us under
* contact@nymea.io or see our FAQ/Licensing Information on
* https://nymea.io/license/faq
*
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */

/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
*
* WARNING
*
* This file has been autogenerated. Any changes in this file may be overwritten.
* If you want to change something, update the register json or the tool.
*
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */

#include "pqidamodbusrtuconnection.h"
#include <loggingcategories.h>
#include <math.h>
#include <QTimer>

NYMEA_LOGGING_CATEGORY(dcPqidaModbusRtuConnection, "PqidaModbusRtuConnection")

PqidaModbusRtuConnection::PqidaModbusRtuConnection(ModbusRtuMaster *modbusRtuMaster, quint16 slaveId, QObject *parent) :
    QObject(parent),
    m_modbusRtuMaster(modbusRtuMaster),
    m_slaveId(slaveId)
{
    connect(m_modbusRtuMaster, &ModbusRtuMaster::connectedChanged, this, [=](bool connected){
        if (connected) {
            qCDebug(dcPqidaModbusRtuConnection()) << "Modbus RTU resource" << m_modbusRtuMaster->serialPort() << "connected again. Start testing if the connection is reachable...";
            m_pendingInitReplies.clear();
            m_pendingUpdateReplies.clear();
            m_communicationWorking = false;
            m_communicationFailedCounter = 0;
            m_checkReachableRetriesCount = 0;
            testReachability();
        } else {
            qCWarning(dcPqidaModbusRtuConnection()) << "Modbus RTU resource" << m_modbusRtuMaster->serialPort() << "disconnected. The connection is not reachable any more.";
            m_communicationWorking = false;
            m_communicationFailedCounter = 0;
            m_checkReachableRetriesCount = 0;
        }

        evaluateReachableState();
    });
}

ModbusRtuMaster *PqidaModbusRtuConnection::modbusRtuMaster() const
{
    return m_modbusRtuMaster;
}
quint16 PqidaModbusRtuConnection::slaveId() const
{
    return m_slaveId;
}

bool PqidaModbusRtuConnection::reachable() const
{
    return m_reachable;
}

uint PqidaModbusRtuConnection::checkReachableRetries() const
{
    return m_checkReachableRetries;
}

void PqidaModbusRtuConnection::setCheckReachableRetries(uint checkReachableRetries)
{
    if (m_checkReachableRetries == checkReachableRetries)
        return;

    m_checkReachableRetries = checkReachableRetries;
    emit checkReachableRetriesChanged(m_checkReachableRetries);
}

ModbusDataUtils::ByteOrder PqidaModbusRtuConnection::endianness() const
{
    return m_endianness;
}

void PqidaModbusRtuConnection::setEndianness(ModbusDataUtils::ByteOrder endianness)
{
    if (m_endianness == endianness)
        return;

    m_endianness = endianness;
    emit endiannessChanged(m_endianness);
}

float PqidaModbusRtuConnection::totalCurrentPower() const
{
    return m_totalCurrentPower;
}

float PqidaModbusRtuConnection::powerPhaseA() const
{
    return m_powerPhaseA;
}

float PqidaModbusRtuConnection::powerPhaseB() const
{
    return m_powerPhaseB;
}

float PqidaModbusRtuConnection::powerPhaseC() const
{
    return m_powerPhaseC;
}

float PqidaModbusRtuConnection::frequency() const
{
    return m_frequency;
}

float PqidaModbusRtuConnection::voltagePhaseA() const
{
    return m_voltagePhaseA;
}

float PqidaModbusRtuConnection::voltagePhaseB() const
{
    return m_voltagePhaseB;
}

float PqidaModbusRtuConnection::voltagePhaseC() const
{
    return m_voltagePhaseC;
}

float PqidaModbusRtuConnection::currentPhaseA() const
{
    return m_currentPhaseA;
}

float PqidaModbusRtuConnection::currentPhaseB() const
{
    return m_currentPhaseB;
}

float PqidaModbusRtuConnection::currentPhaseC() const
{
    return m_currentPhaseC;
}

float PqidaModbusRtuConnection::energyProducedPhaseA() const
{
    return m_energyProducedPhaseA;
}

float PqidaModbusRtuConnection::energyProducedPhaseB() const
{
    return m_energyProducedPhaseB;
}

float PqidaModbusRtuConnection::energyProducedPhaseC() const
{
    return m_energyProducedPhaseC;
}

float PqidaModbusRtuConnection::totalEnergyProduced() const
{
    return m_totalEnergyProduced;
}

float PqidaModbusRtuConnection::energyConsumedPhaseA() const
{
    return m_energyConsumedPhaseA;
}

float PqidaModbusRtuConnection::energyConsumedPhaseB() const
{
    return m_energyConsumedPhaseB;
}

float PqidaModbusRtuConnection::energyConsumedPhaseC() const
{
    return m_energyConsumedPhaseC;
}

float PqidaModbusRtuConnection::totalEnergyConsumed() const
{
    return m_totalEnergyConsumed;
}

bool PqidaModbusRtuConnection::initialize()
{
    if (!m_reachable) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Tried to initialize but the device is not to be reachable.";
        return false;
    }
    // No init registers defined. Nothing to be done and we are finished.
    emit initializationFinished(true);
    return true;
}

bool PqidaModbusRtuConnection::update()
{
    if (!m_modbusRtuMaster->connected()) {
        qCDebug(dcPqidaModbusRtuConnection()) << "Tried to update the registers but the hardware resource seems not to be connected.";
        return false;
    }

    if (!m_pendingUpdateReplies.isEmpty()) {
        qCDebug(dcPqidaModbusRtuConnection()) << "Tried to update the registers but there are still some update replies pending. Waiting for them to be finished...";
        return true;
    }

    // Hardware resource available but communication not working. 
    // Try to read the check reachability register to re-evaluatoe the communication... 
    if (m_modbusRtuMaster->connected() && !m_communicationWorking) {
        testReachability();
        return false;
    }

    ModbusRtuReply *reply = nullptr;

    // Read Total system power
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Total system power\" register:" << 1964 << "size:" << 2;
    reply = readTotalCurrentPower();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Total system power\" registers";
        return false;
    }

    if (reply->isFinished()) {
        return false; // Broadcast reply returns immediatly
    }

    m_pendingUpdateReplies.append(reply);
    connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
        handleModbusError(reply->error());
        m_pendingUpdateReplies.removeAll(reply);

        if (reply->error() != ModbusRtuReply::NoError) {
            verifyUpdateFinished();
            return;
        }

        QVector<quint16> values = reply->result();
        qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Total system power\" register" << 1964 << "size:" << 2 << values;
        processTotalCurrentPowerRegisterValues(values);
        verifyUpdateFinished();
    });

    connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
        qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Total system power\" registers" << error << reply->errorString();
    });

    // Read Power phase L1
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Power phase L1\" register:" << 1946 << "size:" << 2;
    reply = readPowerPhaseA();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Power phase L1\" registers";
        return false;
    }

    if (reply->isFinished()) {
        return false; // Broadcast reply returns immediatly
    }

    m_pendingUpdateReplies.append(reply);
    connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
        handleModbusError(reply->error());
        m_pendingUpdateReplies.removeAll(reply);

        if (reply->error() != ModbusRtuReply::NoError) {
            verifyUpdateFinished();
            return;
        }

        QVector<quint16> values = reply->result();
        qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Power phase L1\" register" << 1946 << "size:" << 2 << values;
        processPowerPhaseARegisterValues(values);
        verifyUpdateFinished();
    });

    connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
        qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Power phase L1\" registers" << error << reply->errorString();
    });

    // Read Power phase L2
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Power phase L2\" register:" << 1952 << "size:" << 2;
    reply = readPowerPhaseB();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Power phase L2\" registers";
        return false;
    }

    if (reply->isFinished()) {
        return false; // Broadcast reply returns immediatly
    }

    m_pendingUpdateReplies.append(reply);
    connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
        handleModbusError(reply->error());
        m_pendingUpdateReplies.removeAll(reply);

        if (reply->error() != ModbusRtuReply::NoError) {
            verifyUpdateFinished();
            return;
        }

        QVector<quint16> values = reply->result();
        qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Power phase L2\" register" << 1952 << "size:" << 2 << values;
        processPowerPhaseBRegisterValues(values);
        verifyUpdateFinished();
    });

    connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
        qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Power phase L2\" registers" << error << reply->errorString();
    });

    // Read Power phase L3
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Power phase L3\" register:" << 1958 << "size:" << 2;
    reply = readPowerPhaseC();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Power phase L3\" registers";
        return false;
    }

    if (reply->isFinished()) {
        return false; // Broadcast reply returns immediatly
    }

    m_pendingUpdateReplies.append(reply);
    connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
        handleModbusError(reply->error());
        m_pendingUpdateReplies.removeAll(reply);

        if (reply->error() != ModbusRtuReply::NoError) {
            verifyUpdateFinished();
            return;
        }

        QVector<quint16> values = reply->result();
        qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Power phase L3\" register" << 1958 << "size:" << 2 << values;
        processPowerPhaseCRegisterValues(values);
        verifyUpdateFinished();
    });

    connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
        qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Power phase L3\" registers" << error << reply->errorString();
    });

    // Read phaseVoltageAndFrequency
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read block \"phaseVoltageAndFrequency\" registers from:" << 1008 << "size:" << 8;
    reply = readBlockPhaseVoltageAndFrequency();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading block \"phaseVoltageAndFrequency\" registers";
        return false;
    }

    if (reply->isFinished()) {
        return false; // Broadcast reply returns immediatly
    }

    m_pendingUpdateReplies.append(reply);
    connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
        handleModbusError(reply->error());
        m_pendingUpdateReplies.removeAll(reply);

        if (reply->error() != ModbusRtuReply::NoError) {
            verifyUpdateFinished();
            return;
        }

        QVector<quint16> blockValues = reply->result();
        qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from reading block \"phaseVoltageAndFrequency\" register" << 1008 << "size:" << 8 << blockValues;
        processFrequencyRegisterValues(blockValues.mid(0, 2));
        processVoltagePhaseARegisterValues(blockValues.mid(2, 2));
        processVoltagePhaseBRegisterValues(blockValues.mid(4, 2));
        processVoltagePhaseCRegisterValues(blockValues.mid(6, 2));
        verifyUpdateFinished();
    });

    connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
        qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating block \"phaseVoltageAndFrequency\" registers" << error << reply->errorString();
    });


    // Read phaseCurrent
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read block \"phaseCurrent\" registers from:" << 1586 << "size:" << 6;
    reply = readBlockPhaseCurrent();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading block \"phaseCurrent\" registers";
        return false;
    }

    if (reply->isFinished()) {
        return false; // Broadcast reply returns immediatly
    }

    m_pendingUpdateReplies.append(reply);
    connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
        handleModbusError(reply->error());
        m_pendingUpdateReplies.removeAll(reply);

        if (reply->error() != ModbusRtuReply::NoError) {
            verifyUpdateFinished();
            return;
        }

        QVector<quint16> blockValues = reply->result();
        qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from reading block \"phaseCurrent\" register" << 1586 << "size:" << 6 << blockValues;
        processCurrentPhaseARegisterValues(blockValues.mid(0, 2));
        processCurrentPhaseBRegisterValues(blockValues.mid(2, 2));
        processCurrentPhaseCRegisterValues(blockValues.mid(4, 2));
        verifyUpdateFinished();
    });

    connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
        qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating block \"phaseCurrent\" registers" << error << reply->errorString();
    });


    // Read energy
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read block \"energy\" registers from:" << 2170 << "size:" << 16;
    reply = readBlockEnergy();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading block \"energy\" registers";
        return false;
    }

    if (reply->isFinished()) {
        return false; // Broadcast reply returns immediatly
    }

    m_pendingUpdateReplies.append(reply);
    connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
        handleModbusError(reply->error());
        m_pendingUpdateReplies.removeAll(reply);

        if (reply->error() != ModbusRtuReply::NoError) {
            verifyUpdateFinished();
            return;
        }

        QVector<quint16> blockValues = reply->result();
        qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from reading block \"energy\" register" << 2170 << "size:" << 16 << blockValues;
        processEnergyProducedPhaseARegisterValues(blockValues.mid(0, 2));
        processEnergyProducedPhaseBRegisterValues(blockValues.mid(2, 2));
        processEnergyProducedPhaseCRegisterValues(blockValues.mid(4, 2));
        processTotalEnergyProducedRegisterValues(blockValues.mid(6, 2));
        processEnergyConsumedPhaseARegisterValues(blockValues.mid(8, 2));
        processEnergyConsumedPhaseBRegisterValues(blockValues.mid(10, 2));
        processEnergyConsumedPhaseCRegisterValues(blockValues.mid(12, 2));
        processTotalEnergyConsumedRegisterValues(blockValues.mid(14, 2));
        verifyUpdateFinished();
    });

    connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
        qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating block \"energy\" registers" << error << reply->errorString();
    });

    return true;
}

void PqidaModbusRtuConnection::updateTotalCurrentPower()
{
    // Update registers from Total system power
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Total system power\" register:" << 1964 << "size:" << 2;
    ModbusRtuReply *reply = readTotalCurrentPower();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Total system power\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Total system power\" register" << 1964 << "size:" << 2 << values;
                processTotalCurrentPowerRegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Total system power\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updatePowerPhaseA()
{
    // Update registers from Power phase L1
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Power phase L1\" register:" << 1946 << "size:" << 2;
    ModbusRtuReply *reply = readPowerPhaseA();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Power phase L1\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Power phase L1\" register" << 1946 << "size:" << 2 << values;
                processPowerPhaseARegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Power phase L1\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updatePowerPhaseB()
{
    // Update registers from Power phase L2
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Power phase L2\" register:" << 1952 << "size:" << 2;
    ModbusRtuReply *reply = readPowerPhaseB();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Power phase L2\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Power phase L2\" register" << 1952 << "size:" << 2 << values;
                processPowerPhaseBRegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Power phase L2\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updatePowerPhaseC()
{
    // Update registers from Power phase L3
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Power phase L3\" register:" << 1958 << "size:" << 2;
    ModbusRtuReply *reply = readPowerPhaseC();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Power phase L3\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Power phase L3\" register" << 1958 << "size:" << 2 << values;
                processPowerPhaseCRegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Power phase L3\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateFrequency()
{
    // Update registers from Frequency
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Frequency\" register:" << 1008 << "size:" << 2;
    ModbusRtuReply *reply = readFrequency();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Frequency\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Frequency\" register" << 1008 << "size:" << 2 << values;
                processFrequencyRegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Frequency\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateVoltagePhaseA()
{
    // Update registers from Voltage phase L1
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Voltage phase L1\" register:" << 1010 << "size:" << 2;
    ModbusRtuReply *reply = readVoltagePhaseA();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Voltage phase L1\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Voltage phase L1\" register" << 1010 << "size:" << 2 << values;
                processVoltagePhaseARegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Voltage phase L1\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateVoltagePhaseB()
{
    // Update registers from Voltage phase L2
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Voltage phase L2\" register:" << 1012 << "size:" << 2;
    ModbusRtuReply *reply = readVoltagePhaseB();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Voltage phase L2\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Voltage phase L2\" register" << 1012 << "size:" << 2 << values;
                processVoltagePhaseBRegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Voltage phase L2\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateVoltagePhaseC()
{
    // Update registers from Voltage phase L3
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Voltage phase L3\" register:" << 1014 << "size:" << 2;
    ModbusRtuReply *reply = readVoltagePhaseC();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Voltage phase L3\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Voltage phase L3\" register" << 1014 << "size:" << 2 << values;
                processVoltagePhaseCRegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Voltage phase L3\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateCurrentPhaseA()
{
    // Update registers from Current phase L1
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Current phase L1\" register:" << 1586 << "size:" << 2;
    ModbusRtuReply *reply = readCurrentPhaseA();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Current phase L1\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Current phase L1\" register" << 1586 << "size:" << 2 << values;
                processCurrentPhaseARegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Current phase L1\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateCurrentPhaseB()
{
    // Update registers from Current phase L2
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Current phase L2\" register:" << 1588 << "size:" << 2;
    ModbusRtuReply *reply = readCurrentPhaseB();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Current phase L2\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Current phase L2\" register" << 1588 << "size:" << 2 << values;
                processCurrentPhaseBRegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Current phase L2\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateCurrentPhaseC()
{
    // Update registers from Current phase L3
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Current phase L3\" register:" << 1590 << "size:" << 2;
    ModbusRtuReply *reply = readCurrentPhaseC();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Current phase L3\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Current phase L3\" register" << 1590 << "size:" << 2 << values;
                processCurrentPhaseCRegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Current phase L3\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateEnergyProducedPhaseA()
{
    // Update registers from Energy consumed L1
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Energy consumed L1\" register:" << 2170 << "size:" << 2;
    ModbusRtuReply *reply = readEnergyProducedPhaseA();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Energy consumed L1\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Energy consumed L1\" register" << 2170 << "size:" << 2 << values;
                processEnergyProducedPhaseARegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Energy consumed L1\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateEnergyProducedPhaseB()
{
    // Update registers from Energy produced L2
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Energy produced L2\" register:" << 2172 << "size:" << 2;
    ModbusRtuReply *reply = readEnergyProducedPhaseB();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Energy produced L2\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Energy produced L2\" register" << 2172 << "size:" << 2 << values;
                processEnergyProducedPhaseBRegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Energy produced L2\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateEnergyProducedPhaseC()
{
    // Update registers from Energy produced L3
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Energy produced L3\" register:" << 2174 << "size:" << 2;
    ModbusRtuReply *reply = readEnergyProducedPhaseC();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Energy produced L3\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Energy produced L3\" register" << 2174 << "size:" << 2 << values;
                processEnergyProducedPhaseCRegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Energy produced L3\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateTotalEnergyProduced()
{
    // Update registers from Total energy produced
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Total energy produced\" register:" << 2176 << "size:" << 2;
    ModbusRtuReply *reply = readTotalEnergyProduced();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Total energy produced\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Total energy produced\" register" << 2176 << "size:" << 2 << values;
                processTotalEnergyProducedRegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Total energy produced\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateEnergyConsumedPhaseA()
{
    // Update registers from Energy consumed L1
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Energy consumed L1\" register:" << 2178 << "size:" << 2;
    ModbusRtuReply *reply = readEnergyConsumedPhaseA();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Energy consumed L1\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Energy consumed L1\" register" << 2178 << "size:" << 2 << values;
                processEnergyConsumedPhaseARegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Energy consumed L1\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateEnergyConsumedPhaseB()
{
    // Update registers from Energy consumed L2
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Energy consumed L2\" register:" << 2180 << "size:" << 2;
    ModbusRtuReply *reply = readEnergyConsumedPhaseB();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Energy consumed L2\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Energy consumed L2\" register" << 2180 << "size:" << 2 << values;
                processEnergyConsumedPhaseBRegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Energy consumed L2\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateEnergyConsumedPhaseC()
{
    // Update registers from Energy consumed L3
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Energy consumed L3\" register:" << 2182 << "size:" << 2;
    ModbusRtuReply *reply = readEnergyConsumedPhaseC();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Energy consumed L3\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Energy consumed L3\" register" << 2182 << "size:" << 2 << values;
                processEnergyConsumedPhaseCRegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Energy consumed L3\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateTotalEnergyConsumed()
{
    // Update registers from Total energy consumed
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read \"Total energy consumed\" register:" << 2184 << "size:" << 2;
    ModbusRtuReply *reply = readTotalEnergyConsumed();
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading \"Total energy consumed\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> values = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from \"Total energy consumed\" register" << 2184 << "size:" << 2 << values;
                processTotalEnergyConsumedRegisterValues(values);
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating \"Total energy consumed\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updatePhaseVoltageAndFrequencyBlock()
{
    // Update register block "phaseVoltageAndFrequency"
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read block \"phaseVoltageAndFrequency\" registers from:" << 1008 << "size:" << 8;
    ModbusRtuReply *reply = m_modbusRtuMaster->readHoldingRegister(m_slaveId, 1008, 8);
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading block \"phaseVoltageAndFrequency\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> blockValues = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from reading block \"phaseVoltageAndFrequency\" register" << 1008 << "size:" << 8 << blockValues;
                processFrequencyRegisterValues(blockValues.mid(0, 2));
                processVoltagePhaseARegisterValues(blockValues.mid(2, 2));
                processVoltagePhaseBRegisterValues(blockValues.mid(4, 2));
                processVoltagePhaseCRegisterValues(blockValues.mid(6, 2));
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating block \"phaseVoltageAndFrequency\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updatePhaseCurrentBlock()
{
    // Update register block "phaseCurrent"
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read block \"phaseCurrent\" registers from:" << 1586 << "size:" << 6;
    ModbusRtuReply *reply = m_modbusRtuMaster->readHoldingRegister(m_slaveId, 1586, 6);
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading block \"phaseCurrent\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> blockValues = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from reading block \"phaseCurrent\" register" << 1586 << "size:" << 6 << blockValues;
                processCurrentPhaseARegisterValues(blockValues.mid(0, 2));
                processCurrentPhaseBRegisterValues(blockValues.mid(2, 2));
                processCurrentPhaseCRegisterValues(blockValues.mid(4, 2));
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating block \"phaseCurrent\" registers" << error << reply->errorString();
        });
    }
}

void PqidaModbusRtuConnection::updateEnergyBlock()
{
    // Update register block "energy"
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Read block \"energy\" registers from:" << 2170 << "size:" << 16;
    ModbusRtuReply *reply = m_modbusRtuMaster->readHoldingRegister(m_slaveId, 2170, 16);
    if (!reply) {
        qCWarning(dcPqidaModbusRtuConnection()) << "Error occurred while reading block \"energy\" registers";
        return;
    }

    if (!reply->isFinished()) {
        connect(reply, &ModbusRtuReply::finished, this, [this, reply](){
            handleModbusError(reply->error());
            if (reply->error() == ModbusRtuReply::NoError) {
                QVector<quint16> blockValues = reply->result();
                qCDebug(dcPqidaModbusRtuConnection()) << "<-- Response from reading block \"energy\" register" << 2170 << "size:" << 16 << blockValues;
                processEnergyProducedPhaseARegisterValues(blockValues.mid(0, 2));
                processEnergyProducedPhaseBRegisterValues(blockValues.mid(2, 2));
                processEnergyProducedPhaseCRegisterValues(blockValues.mid(4, 2));
                processTotalEnergyProducedRegisterValues(blockValues.mid(6, 2));
                processEnergyConsumedPhaseARegisterValues(blockValues.mid(8, 2));
                processEnergyConsumedPhaseBRegisterValues(blockValues.mid(10, 2));
                processEnergyConsumedPhaseCRegisterValues(blockValues.mid(12, 2));
                processTotalEnergyConsumedRegisterValues(blockValues.mid(14, 2));
            }
        });

        connect(reply, &ModbusRtuReply::errorOccurred, this, [reply] (ModbusRtuReply::Error error){
            qCWarning(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while updating block \"energy\" registers" << error << reply->errorString();
        });
    }
}

ModbusRtuReply *PqidaModbusRtuConnection::readTotalCurrentPower()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 1964, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readPowerPhaseA()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 1946, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readPowerPhaseB()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 1952, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readPowerPhaseC()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 1958, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readFrequency()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 1008, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readVoltagePhaseA()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 1010, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readVoltagePhaseB()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 1012, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readVoltagePhaseC()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 1014, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readCurrentPhaseA()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 1586, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readCurrentPhaseB()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 1588, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readCurrentPhaseC()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 1590, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readEnergyProducedPhaseA()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 2170, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readEnergyProducedPhaseB()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 2172, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readEnergyProducedPhaseC()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 2174, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readTotalEnergyProduced()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 2176, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readEnergyConsumedPhaseA()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 2178, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readEnergyConsumedPhaseB()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 2180, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readEnergyConsumedPhaseC()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 2182, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readTotalEnergyConsumed()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 2184, 2);
}

ModbusRtuReply *PqidaModbusRtuConnection::readBlockPhaseVoltageAndFrequency()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 1008, 8);
}

ModbusRtuReply *PqidaModbusRtuConnection::readBlockPhaseCurrent()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 1586, 6);
}

ModbusRtuReply *PqidaModbusRtuConnection::readBlockEnergy()
{
    return m_modbusRtuMaster->readHoldingRegister(m_slaveId, 2170, 16);
}

void PqidaModbusRtuConnection::processTotalCurrentPowerRegisterValues(const QVector<quint16> values)
{
    float receivedTotalCurrentPower = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit totalCurrentPowerReadFinished(receivedTotalCurrentPower);

    if (m_totalCurrentPower != receivedTotalCurrentPower) {
        m_totalCurrentPower = receivedTotalCurrentPower;
        emit totalCurrentPowerChanged(m_totalCurrentPower);
    }
}

void PqidaModbusRtuConnection::processPowerPhaseARegisterValues(const QVector<quint16> values)
{
    float receivedPowerPhaseA = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit powerPhaseAReadFinished(receivedPowerPhaseA);

    if (m_powerPhaseA != receivedPowerPhaseA) {
        m_powerPhaseA = receivedPowerPhaseA;
        emit powerPhaseAChanged(m_powerPhaseA);
    }
}

void PqidaModbusRtuConnection::processPowerPhaseBRegisterValues(const QVector<quint16> values)
{
    float receivedPowerPhaseB = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit powerPhaseBReadFinished(receivedPowerPhaseB);

    if (m_powerPhaseB != receivedPowerPhaseB) {
        m_powerPhaseB = receivedPowerPhaseB;
        emit powerPhaseBChanged(m_powerPhaseB);
    }
}

void PqidaModbusRtuConnection::processPowerPhaseCRegisterValues(const QVector<quint16> values)
{
    float receivedPowerPhaseC = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit powerPhaseCReadFinished(receivedPowerPhaseC);

    if (m_powerPhaseC != receivedPowerPhaseC) {
        m_powerPhaseC = receivedPowerPhaseC;
        emit powerPhaseCChanged(m_powerPhaseC);
    }
}

void PqidaModbusRtuConnection::processFrequencyRegisterValues(const QVector<quint16> values)
{
    float receivedFrequency = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit frequencyReadFinished(receivedFrequency);

    if (m_frequency != receivedFrequency) {
        m_frequency = receivedFrequency;
        emit frequencyChanged(m_frequency);
    }
}

void PqidaModbusRtuConnection::processVoltagePhaseARegisterValues(const QVector<quint16> values)
{
    float receivedVoltagePhaseA = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit voltagePhaseAReadFinished(receivedVoltagePhaseA);

    if (m_voltagePhaseA != receivedVoltagePhaseA) {
        m_voltagePhaseA = receivedVoltagePhaseA;
        emit voltagePhaseAChanged(m_voltagePhaseA);
    }
}

void PqidaModbusRtuConnection::processVoltagePhaseBRegisterValues(const QVector<quint16> values)
{
    float receivedVoltagePhaseB = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit voltagePhaseBReadFinished(receivedVoltagePhaseB);

    if (m_voltagePhaseB != receivedVoltagePhaseB) {
        m_voltagePhaseB = receivedVoltagePhaseB;
        emit voltagePhaseBChanged(m_voltagePhaseB);
    }
}

void PqidaModbusRtuConnection::processVoltagePhaseCRegisterValues(const QVector<quint16> values)
{
    float receivedVoltagePhaseC = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit voltagePhaseCReadFinished(receivedVoltagePhaseC);

    if (m_voltagePhaseC != receivedVoltagePhaseC) {
        m_voltagePhaseC = receivedVoltagePhaseC;
        emit voltagePhaseCChanged(m_voltagePhaseC);
    }
}

void PqidaModbusRtuConnection::processCurrentPhaseARegisterValues(const QVector<quint16> values)
{
    float receivedCurrentPhaseA = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit currentPhaseAReadFinished(receivedCurrentPhaseA);

    if (m_currentPhaseA != receivedCurrentPhaseA) {
        m_currentPhaseA = receivedCurrentPhaseA;
        emit currentPhaseAChanged(m_currentPhaseA);
    }
}

void PqidaModbusRtuConnection::processCurrentPhaseBRegisterValues(const QVector<quint16> values)
{
    float receivedCurrentPhaseB = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit currentPhaseBReadFinished(receivedCurrentPhaseB);

    if (m_currentPhaseB != receivedCurrentPhaseB) {
        m_currentPhaseB = receivedCurrentPhaseB;
        emit currentPhaseBChanged(m_currentPhaseB);
    }
}

void PqidaModbusRtuConnection::processCurrentPhaseCRegisterValues(const QVector<quint16> values)
{
    float receivedCurrentPhaseC = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit currentPhaseCReadFinished(receivedCurrentPhaseC);

    if (m_currentPhaseC != receivedCurrentPhaseC) {
        m_currentPhaseC = receivedCurrentPhaseC;
        emit currentPhaseCChanged(m_currentPhaseC);
    }
}

void PqidaModbusRtuConnection::processEnergyProducedPhaseARegisterValues(const QVector<quint16> values)
{
    float receivedEnergyProducedPhaseA = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit energyProducedPhaseAReadFinished(receivedEnergyProducedPhaseA);

    if (m_energyProducedPhaseA != receivedEnergyProducedPhaseA) {
        m_energyProducedPhaseA = receivedEnergyProducedPhaseA;
        emit energyProducedPhaseAChanged(m_energyProducedPhaseA);
    }
}

void PqidaModbusRtuConnection::processEnergyProducedPhaseBRegisterValues(const QVector<quint16> values)
{
    float receivedEnergyProducedPhaseB = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit energyProducedPhaseBReadFinished(receivedEnergyProducedPhaseB);

    if (m_energyProducedPhaseB != receivedEnergyProducedPhaseB) {
        m_energyProducedPhaseB = receivedEnergyProducedPhaseB;
        emit energyProducedPhaseBChanged(m_energyProducedPhaseB);
    }
}

void PqidaModbusRtuConnection::processEnergyProducedPhaseCRegisterValues(const QVector<quint16> values)
{
    float receivedEnergyProducedPhaseC = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit energyProducedPhaseCReadFinished(receivedEnergyProducedPhaseC);

    if (m_energyProducedPhaseC != receivedEnergyProducedPhaseC) {
        m_energyProducedPhaseC = receivedEnergyProducedPhaseC;
        emit energyProducedPhaseCChanged(m_energyProducedPhaseC);
    }
}

void PqidaModbusRtuConnection::processTotalEnergyProducedRegisterValues(const QVector<quint16> values)
{
    float receivedTotalEnergyProduced = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit totalEnergyProducedReadFinished(receivedTotalEnergyProduced);

    if (m_totalEnergyProduced != receivedTotalEnergyProduced) {
        m_totalEnergyProduced = receivedTotalEnergyProduced;
        emit totalEnergyProducedChanged(m_totalEnergyProduced);
    }
}

void PqidaModbusRtuConnection::processEnergyConsumedPhaseARegisterValues(const QVector<quint16> values)
{
    float receivedEnergyConsumedPhaseA = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit energyConsumedPhaseAReadFinished(receivedEnergyConsumedPhaseA);

    if (m_energyConsumedPhaseA != receivedEnergyConsumedPhaseA) {
        m_energyConsumedPhaseA = receivedEnergyConsumedPhaseA;
        emit energyConsumedPhaseAChanged(m_energyConsumedPhaseA);
    }
}

void PqidaModbusRtuConnection::processEnergyConsumedPhaseBRegisterValues(const QVector<quint16> values)
{
    float receivedEnergyConsumedPhaseB = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit energyConsumedPhaseBReadFinished(receivedEnergyConsumedPhaseB);

    if (m_energyConsumedPhaseB != receivedEnergyConsumedPhaseB) {
        m_energyConsumedPhaseB = receivedEnergyConsumedPhaseB;
        emit energyConsumedPhaseBChanged(m_energyConsumedPhaseB);
    }
}

void PqidaModbusRtuConnection::processEnergyConsumedPhaseCRegisterValues(const QVector<quint16> values)
{
    float receivedEnergyConsumedPhaseC = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit energyConsumedPhaseCReadFinished(receivedEnergyConsumedPhaseC);

    if (m_energyConsumedPhaseC != receivedEnergyConsumedPhaseC) {
        m_energyConsumedPhaseC = receivedEnergyConsumedPhaseC;
        emit energyConsumedPhaseCChanged(m_energyConsumedPhaseC);
    }
}

void PqidaModbusRtuConnection::processTotalEnergyConsumedRegisterValues(const QVector<quint16> values)
{
    float receivedTotalEnergyConsumed = ModbusDataUtils::convertToFloat32(values, m_endianness);
    emit totalEnergyConsumedReadFinished(receivedTotalEnergyConsumed);

    if (m_totalEnergyConsumed != receivedTotalEnergyConsumed) {
        m_totalEnergyConsumed = receivedTotalEnergyConsumed;
        emit totalEnergyConsumedChanged(m_totalEnergyConsumed);
    }
}

void PqidaModbusRtuConnection::handleModbusError(ModbusRtuReply::Error error)
{
    if (error == ModbusRtuReply::NoError) {
        // Reset the communication counter and we know we can reach the device
        m_communicationFailedCounter = 0;
        if (!m_communicationWorking)
            qCDebug(dcPqidaModbusRtuConnection()) << "Received a reply without any errors. The communication with the device seems to work now.";

        m_communicationWorking = true;
        evaluateReachableState();
    } else {
        m_communicationFailedCounter++;
        if (m_communicationWorking && m_communicationFailedCounter >= m_communicationFailedMax) {
            m_communicationWorking = false;
            qCWarning(dcPqidaModbusRtuConnection()) << "Received" << m_communicationFailedCounter << "errors while communicating with the RTU master. Mark as not reachable until the communication works again.";
            evaluateReachableState();
        }
    }
}

void PqidaModbusRtuConnection::testReachability()
{
    if (m_checkRechableReply)
        return;

    // Try to read the check reachability register voltagePhaseA in order to verify if the communication is working or not.
    qCDebug(dcPqidaModbusRtuConnection()) << "--> Test reachability by reading \"Voltage phase L1\" register:" << 1010 << "size:" << 2;
    m_checkRechableReply = readVoltagePhaseA();
    if (!m_checkRechableReply) {
        qCDebug(dcPqidaModbusRtuConnection()) << "Error occurred verifying reachability by reading \"Voltage phase L1\" register";
        onReachabilityCheckFailed();
        return;
    }

    if (m_checkRechableReply->isFinished()) {
        m_checkRechableReply = nullptr;
        onReachabilityCheckFailed();
        return;
    }

    connect(m_checkRechableReply, &ModbusRtuReply::finished, this, [this](){
        // Note: we don't care about the result here, only the error
        handleModbusError(m_checkRechableReply->error());
        if (m_checkRechableReply->error() != ModbusRtuReply::NoError)
            onReachabilityCheckFailed();

        m_checkRechableReply = nullptr;
    });

    connect(m_checkRechableReply, &ModbusRtuReply::errorOccurred, this, [this] (ModbusRtuReply::Error error){
        qCDebug(dcPqidaModbusRtuConnection()) << "ModbusRtu reply error occurred while verifying reachability by reading \"Voltage phase L1\" register" << error << m_checkRechableReply->errorString();
    });
}

void PqidaModbusRtuConnection::verifyInitFinished()
{
    if (m_pendingInitReplies.isEmpty()) {
        finishInitialization(true);
    }
}

void PqidaModbusRtuConnection::finishInitialization(bool success)
{
    if (success) {
        qCDebug(dcPqidaModbusRtuConnection()) << "Initialization finished of PqidaModbusRtuConnection finished successfully";
    } else {
        qCWarning(dcPqidaModbusRtuConnection()) << "Initialization finished of PqidaModbusRtuConnection failed.";
    }

    // Cleanup init
    delete m_initObject;
    m_initObject = nullptr;
    m_pendingInitReplies.clear();

    emit initializationFinished(success);
}

void PqidaModbusRtuConnection::verifyUpdateFinished()
{
    if (m_pendingUpdateReplies.isEmpty()) {
        emit updateFinished();
    }
}

void PqidaModbusRtuConnection::onReachabilityCheckFailed()
{
    m_checkReachableRetriesCount++;

    if (m_checkReachableRetriesCount <= m_checkReachableRetries) {
        qCDebug(dcPqidaModbusRtuConnection()) << "Reachability test failed. Retry in on second" << m_checkReachableRetriesCount << "/" << m_checkReachableRetries;
        QTimer::singleShot(1000, this, &PqidaModbusRtuConnection::testReachability);
        return;
    }

    // The test reachability method failed, not retrying any more
    emit checkReachabilityFailed();
}

void PqidaModbusRtuConnection::evaluateReachableState()
{
    bool reachable = m_communicationWorking && m_modbusRtuMaster->connected();
    if (m_reachable == reachable)
        return;

    m_reachable = reachable;
    emit reachableChanged(m_reachable);
    m_checkReachableRetriesCount = 0;
}

QDebug operator<<(QDebug debug, PqidaModbusRtuConnection *pqidaModbusRtuConnection)
{
    debug.nospace().noquote() << "PqidaModbusRtuConnection(" << pqidaModbusRtuConnection->modbusRtuMaster()->modbusUuid().toString() << ", " << pqidaModbusRtuConnection->modbusRtuMaster()->serialPort() << ", slave ID:" << pqidaModbusRtuConnection->slaveId() << ")" << "\n";
    debug.nospace().noquote() << "    - Total system power: " << pqidaModbusRtuConnection->totalCurrentPower() << " [W]" << "\n";
    debug.nospace().noquote() << "    - Power phase L1: " << pqidaModbusRtuConnection->powerPhaseA() << " [W]" << "\n";
    debug.nospace().noquote() << "    - Power phase L2: " << pqidaModbusRtuConnection->powerPhaseB() << " [W]" << "\n";
    debug.nospace().noquote() << "    - Power phase L3: " << pqidaModbusRtuConnection->powerPhaseC() << " [W]" << "\n";
    debug.nospace().noquote() << "    - Frequency: " << pqidaModbusRtuConnection->frequency() << " [Hz]" << "\n";
    debug.nospace().noquote() << "    - Voltage phase L1: " << pqidaModbusRtuConnection->voltagePhaseA() << " [V]" << "\n";
    debug.nospace().noquote() << "    - Voltage phase L2: " << pqidaModbusRtuConnection->voltagePhaseB() << " [V]" << "\n";
    debug.nospace().noquote() << "    - Voltage phase L3: " << pqidaModbusRtuConnection->voltagePhaseC() << " [V]" << "\n";
    debug.nospace().noquote() << "    - Current phase L1: " << pqidaModbusRtuConnection->currentPhaseA() << " [A]" << "\n";
    debug.nospace().noquote() << "    - Current phase L2: " << pqidaModbusRtuConnection->currentPhaseB() << " [A]" << "\n";
    debug.nospace().noquote() << "    - Current phase L3: " << pqidaModbusRtuConnection->currentPhaseC() << " [A]" << "\n";
    debug.nospace().noquote() << "    - Energy consumed L1: " << pqidaModbusRtuConnection->energyProducedPhaseA() << " [kWh]" << "\n";
    debug.nospace().noquote() << "    - Energy produced L2: " << pqidaModbusRtuConnection->energyProducedPhaseB() << " [kWh]" << "\n";
    debug.nospace().noquote() << "    - Energy produced L3: " << pqidaModbusRtuConnection->energyProducedPhaseC() << " [kWh]" << "\n";
    debug.nospace().noquote() << "    - Total energy produced: " << pqidaModbusRtuConnection->totalEnergyProduced() << " [kWh]" << "\n";
    debug.nospace().noquote() << "    - Energy consumed L1: " << pqidaModbusRtuConnection->energyConsumedPhaseA() << " [kWh]" << "\n";
    debug.nospace().noquote() << "    - Energy consumed L2: " << pqidaModbusRtuConnection->energyConsumedPhaseB() << " [kWh]" << "\n";
    debug.nospace().noquote() << "    - Energy consumed L3: " << pqidaModbusRtuConnection->energyConsumedPhaseC() << " [kWh]" << "\n";
    debug.nospace().noquote() << "    - Total energy consumed: " << pqidaModbusRtuConnection->totalEnergyConsumed() << " [kWh]" << "\n";
    return debug.quote().space();
}

